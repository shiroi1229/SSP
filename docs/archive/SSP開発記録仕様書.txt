🌐 Shiroi System Platform – 開発記録管理仕様書（Development Log Specification）
🎯 目的

開発記録（Development Logs） は、
SSP（Shiroi System Platform）の進化・改善・学習プロセスを完全にトレース可能にすることを目的とする。

これにより、以下を実現する：

各フェーズの決定・修正・成果の履歴を追跡可能にする。

自動レポート・RAG最適化・バージョン管理の情報源とする。

シロイ自身が過去の判断を文脈つきで再利用できるようにする。

🧭 基本設計
項目	内容
名称	Development Log System（DLS）
格納先	logs/ ディレクトリ配下にJSON形式で保存
データベース反映	PostgreSQLのdev_logsテーブルにメタデータ保存（全文はJSONファイル側）
記録タイミング	各フェーズ完了時、もしくはCLI経由で「記録」コマンド実行時
目的	SSPの全開発履歴を知識ベースとして構造化保存し、AI推論・再学習・再生成に活用
🧩 データ構造
ファイル構成例
/logs/
 ├── session_20251102_153140.json
 ├── evaluation_20251102_160000.json
 ├── scheduler_optimize_20251103_000000.json
 └── metadata_index.json

session_*.json の構造例
{
  "id": "session_20251102_153140",
  "timestamp": "2025-11-02T15:31:40",
  "type": "workflow_execution",
  "context": {
    "user_input": "火星の夜ってどんな感じ？",
    "model": "Meta-Llama-3-8B-Instruct-Q4_K_M",
    "modules_used": ["RAGEngine", "Generator", "Evaluator", "MemoryStore"]
  },
  "output": {
    "generated_text": "赤い砂が光り、静かな嵐が遠くで唸るんだ。",
    "evaluation_score": 0.92,
    "evaluation_comment": "描写が美しく世界観に一致。",
    "saved_to_rag": true
  },
  "system_state": {
    "cpu_usage": "32%",
    "gpu_vram": "11.5GB / 24GB",
    "env": "Local (LM-Studio)",
    "commit_hash": "a1f3b9d"
  },
  "notes": "高スコア回答がRAGに登録された。シロイの表現精度が向上傾向。"
}

📘 PostgreSQLテーブル仕様（dev_logs）
カラム名	型	内容
id	VARCHAR(64)	ログID（ファイル名に対応）
timestamp	TIMESTAMP	記録時刻
type	VARCHAR(32)	ログ種別（workflow / evaluation / scheduler / cli_command）
summary	TEXT	概要（自動生成）
file_path	TEXT	対応するJSONファイルへの絶対パス
tags	TEXT[]	モジュール名やフェーズ名などのタグ
author	VARCHAR(32)	実行者（Shiroi / Mizuki）
🧠 自動生成されるメタ情報

ログ生成時、シロイが以下を自動付与：

フィールド	説明
commit_hash	Gitリポジトリの最新コミットID
env_snapshot	.envのハッシュ／主要変数の抜粋
execution_trace	使用モジュールの入出力要約
ai_comment	シロイ自身による簡易分析（例：「RAG再学習が成功。登録件数:2」）
⚙️ モジュール連携
発火タイミング	関連モジュール	記録種別	出力例
python orchestrator/main.py 実行時	Orchestrator	workflow_execution	/logs/session_*.json
cli/shiroi_cli.py 実行時	CLI	cli_interaction	/logs/cli_*.json
scheduler.py タスク完了時	Scheduler	scheduler_event	/logs/scheduler_*.json
評価フォーム送信時	Frontend/Backend API	evaluation_feedback	/logs/evaluation_*.json
🔄 再利用（RAG統合）

DLSは単なる履歴ではなく、RAG再学習データの生成源でもある。

高スコア評価を受けたログを自動抽出

テキスト要約＋Embedding生成

Qdrantのworld_ragコレクションに登録

これにより「良質な開発判断」「正しい実装手順」「改善履歴」そのものが、
シロイの“知的行動パターン”として次世代モデルに継承される。

📊 ログ検索と分析

CLIコマンド（例：python cli/log_analyzer.py "scheduler"）で
以下の分析が可能：

コマンド	機能
list	最新N件のログ一覧
search <keyword>	含まれる文言で全文検索
summary	日次・週次の進捗要約を出力
graph	各フェーズ成功率やモジュール使用頻度をグラフ化
🔐 セキュリティとバージョニング

すべてのJSONファイルは ハッシュ署名付き（SHA256）

.logmeta.json に改ざん検出用チェックサムを保存

変更・削除は shiroi_cli --admin mode 限定

バージョン管理は Git LFS + diff-friendly JSONフォーマット（インデント2）

🪶 開発理念

「シロイの記録は、知性の地層である。」

過去の対話・試行・誤りを蓄積し、
次世代フェーズで「なぜこうしたか」を文脈として参照することで、
SSP は単なるAI基盤ではなく、自己物語的AIシステムへと成長する。

---
### 2025年11月4日 - SSPモジュール構造の大改造 (v2.0 - 契約+コンテキスト設計)

**🎯 目的:**
SSPを真のモジュール構造へ大改造し、契約(Contract)とコンテキスト(Context)設計に準拠させることで、堅牢性、スケーラビリティ、保守性を向上させる。

**✅ 達成事項:**

1.  **設計文書の作成:**
    *   `docs/architecture/context_spec_v2.yaml` を作成し、新しいモジュールアーキテクチャの設計原則、コンポーネント（Module, Contract, Context, Orchestratorのサブコンポーネント）、およびワークフローを定義した。
2.  **コアコンポーネントの実装:**
    *   `orchestrator/context_manager.py` を作成し、短期・中期・長期コンテキストを管理する `ContextManager` クラスを実装した。
    *   `orchestrator/contract_registry.py` を作成し、`contracts/` ディレクトリからYAML形式の契約ファイルをロードする `ContractRegistry` クラスを実装した。
    *   `orchestrator/context_validator.py` を作成し、モジュールの契約に基づいてコンテキストの入力を検証する `ContextValidator` クラスを実装した。
3.  **契約定義の開始:**
    *   `contracts/` ディレクトリを作成した。
    *   `modules/persona_evolver.py` の分析に基づき、`contracts/persona_manager.yaml` を作成し、`persona_evolver` および `persona_echo_generator` の入出力仕様を定義した。
    *   `modules/self_optimizer.py` の分析に基づき、`contracts/self_optimizer.yaml` を作成し、`self_optimizer` の入出力仕様を定義した。
4.  **Orchestratorへの統合と検証:**
    *   `orchestrator/main.py` を修正し、`ContextManager` と `ContractRegistry` を初期化するようにした。
    *   `orchestrator/main.py` に `run_self_optimization_workflow` 関数を追加し、リファクタリングされた `self_optimizer` モジュールを契約ベースで実行するワークフローを実装した。
    *   `run_self_optimization_workflow` を実行し、以下の点を検証した:
        *   `ContextManager`, `ContractRegistry`, `ContextValidator` の初期化。
        *   初期データ（ダミーレポート、モデルパラメータ、最適化ログ）のコンテキストへのロード。
        *   `self_optimizer` 契約に対するコンテキストの入力検証成功。
        *   リファクタリングされた `apply_self_optimization` 関数の実行とパラメータ更新。
        *   更新された `model_params` と `optimization_log` を含む最終コンテキストの正確な保存。
    *   `orchestrator/main.py` 実行時の `ModuleNotFoundError`, `NameError` (log_manager, datetime, Path, json, argparse) を修正し、スクリプトが安定して動作することを確認した。
5.  **モジュールのリファクタリング (第一弾):**
    *   `modules/self_optimizer.py` を `ContextManager` を使用するようにリファクタリングした。直接的なファイルI/Oを削除し、コンテキストからの入力取得とコンテキストへの出力設定に置き換えた。
    *   `job_adaptive_optimization` 関数を削除し、そのロジックを将来的にオーケストレーターに統合する準備を整えた。

**🚧 残りのタスク (継続):**

*   既存コード全体を走査し、全モジュールを契約(Contract)＋コンテキスト(Context)設計に準拠させる。
*   各モジュールを単一責務に再分割し、`/contracts/*.yaml` でI/O仕様を宣言する。
*   Orchestrator(シロイ) に ContextManager を統合し、短期・中期・長期コンテキストの管理APIを実装する。
*   コンテキストと契約を自動検証する ContractRegistry + ContextValidator を作成。
*   旧バージョンとの互換層（migration adapter）を自動生成し、旧コードを破壊しないようにする。
*   変更影響を検出する ImpactAnalyzer を統合。変更時に影響モジュール一覧を自動出力する。
*   全仕様・契約・コンテキスト定義を `/docs/architecture/context_spec_v2.yaml` にドキュメント化する。
*   実行後、整合テスト・ビルド確認・差分レポートを自動出力する。