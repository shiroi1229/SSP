
version: 2.0
spec_name: SSP Context and Contract Specification

overview: >
  This document specifies the design principles for a modular architecture for the 
  Shiroi System Platform (SSP) based on "Contracts" and "Contexts".
  The goal is to evolve SSP into a more robust, scalable, and maintainable system 
  where modules are decoupled and interact through well-defined interfaces.

principles:
  - Single Responsibility: Each module should have a single, well-defined purpose.
  - Explicit Interfaces: All interactions between modules must be declared in "Contracts".
  - Centralized State Management: "Context" provides a managed, predictable way to handle state.
  - Automated Validation: Contracts and Contexts are automatically validated to ensure system integrity.
  - Backward Compatibility: Changes should not break existing functionalities, ensured by a migration layer.

components:
  1. Module:
     description: >
       A self-contained unit of functionality with a single responsibility.
       Each module is defined by its Contract.
     structure:
       - /modules/{module_name}.py

  2. Contract:
     description: >
       A YAML file that defines the I/O specification for a module. It declares the expected 
       inputs (from Context) and the outputs (to Context).
     location: /contracts/{module_name}.yaml
     schema:
       name: String
       description: String
       version: String
       inputs:
         - name: String
           description: String
           source: ContextKey # e.g., "short_term.user_query"
           type: DataType # (String, Integer, List[String], etc.)
           required: Boolean
       outputs:
         - name: String
           description: String
           target: ContextKey # e.g., "intermediate.rag_results"
           type: DataType

  3. Context:
     description: >
       A hierarchical data structure that holds the state of the system. It is managed by the 
       ContextManager and is the single source of truth for module interactions.
     layers:
       - name: long_term
         description: >
           Persistent state that survives across sessions.
           e.g., persona profiles, optimization logs, core identity.
       - name: medium_term
         description: >
           Session-level state. Cleared at the end of a user session.
           e.g., conversation history, current session ID.
       - name: short_term
         description: >
           Request-level state. Cleared after a single request-response cycle.
           e.g., user input, intermediate results from a module chain.

  4. Orchestrator:
     description: >
       The central component that coordinates the execution of modules.
     sub_components:
       - ContextManager:
           description: >
             Manages the lifecycle of the Context (read, write, clear layers).
             Provides a simple API for modules to access the Context.
           api:
             - get(context_key: String) -> Any
             - set(context_key: String, value: Any)
             - clear(layer: String) # short_term, medium_term
       - ContractRegistry:
           description: >
             Loads all Contracts from /contracts/*.yaml at startup.
             Provides a lookup service for module contracts.
       - ContextValidator:
           description: >
             Validates the Context against the Contract of a module before and after its execution.
             Ensures type safety and presence of required data.
       - ImpactAnalyzer:
           description: >
             Analyzes the dependency graph of modules based on their Contracts.
             When a Contract is changed, it identifies and reports all affected modules.
       - MigrationAdapter:
           description: >
             A layer to ensure backward compatibility. When a module is refactored to the new
             architecture, an adapter is created to simulate its old behavior for dependent modules
             that have not yet been migrated.

workflow:
  1. Initialization:
     - Orchestrator starts.
     - ContractRegistry loads all contracts.
     - ContextManager initializes the context layers.
  2. Request Handling:
     - A request triggers a workflow (e.g., user chat).
     - Orchestrator determines the sequence of modules to execute.
  3. Module Execution:
     - For each module in the sequence:
       a. ContextValidator validates the required inputs from the Context against the module's Contract.
       b. Orchestrator executes the module.
       c. The module reads from and writes to the Context via the ContextManager API.
       d. ContextValidator validates the outputs produced by the module against its Contract.
  4. Response Generation:
     - The final result is retrieved from the Context and sent as a response.
  5. Context Cleanup:
     - ContextManager clears the short_term context.

documentation:
  - All contract definitions, context specifications, and architectural diagrams will be maintained
    in the /docs/architecture directory.
